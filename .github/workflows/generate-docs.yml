name: Generate terraform docs
on:
  - pull_request

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.ref }}

    - name: Install TF Docs
      env:
        TERRAFORM_DOCS_VERSION: 0.15.0
      run: |
        wget -O terraform-docs.tar.gz "https://github.com/terraform-docs/terraform-docs/releases/download/v${TERRAFORM_DOCS_VERSION}/terraform-docs-v${TERRAFORM_DOCS_VERSION}-linux-amd64.tar.gz"
        tar -xzf terraform-docs.tar.gz
        chmod +x terraform-docs
        mv terraform-docs bin/terraform-docs
        echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH 
        
    - name: Generate Docs
      run: make docs
    
    - name: Clean up workspace
      run: |
        rm bin/terraform-docs
        rm terraform-docs.tar.gz

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Auto"
        git add -A
        git commit -m "Adding metrics on `date '+%Y-%m-%d'`" -a
        git push https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git HEAD:main